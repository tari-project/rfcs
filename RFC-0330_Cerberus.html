<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>RFC-0330: The Cerberus-Hotstuff consensus algorithm - The Tari Network: RFC library</title>
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="The Tari network RFC library and documentation">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="shortcut icon" href="">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel="stylesheet" type="text/css">
        <link href="https://fonts.googleapis.com/css?family=Source+Code+Pro:500" rel="stylesheet" type="text/css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->

        <!-- MathJax -->
        <script async type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.3/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
        <script type="text/x-mathjax-config">
          MathJax.Hub.Config({
            tex2jax: {
            inlineMath: [ ['$','$'], ["\\(","\\)"] ],
            displayMath: [ ['$$','$$'], ["\\[","\\]"] ],
            processEscapes: true
            }
          });
        </script>

        <!-- Google tag (gtag.js) -->
        <script async src="https://www.googletagmanager.com/gtag/js?id=G-0Q69T0B1T4"></script>
        <script>
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());

          gtag('config', 'G-0Q69T0B1T4');
        </script>

    </head>
    <body class="light">
        <!-- Provide site root to javascript -->
        <script type="text/javascript">var path_to_root = "";</script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var sidebar = localStorage.getItem('mdbook-sidebar');
                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme = 'light';
            document.body.className = theme;
            document.querySelector('html').className = theme + ' js';
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <img src="theme/images/tari-splash.png" class="tlu">

            <ol class="chapter"><li class="chapter-item expanded affix "><a href="about.html">About the Tari RFC documents</a></li><li class="chapter-item expanded "><a href="RFC-0001_overview.html"><strong aria-hidden="true">1.</strong> RFC-0001: An overview of the Tari network</a></li><li class="chapter-item expanded "><a href="base_layer.html"><strong aria-hidden="true">2.</strong> The Tari Base Layer</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="RFC-0110_BaseNodes.html"><strong aria-hidden="true">2.1.</strong> RFC-0110: Base nodes</a></li><li class="chapter-item expanded "><a href="RFC-0111_BaseNodeArchitecture.html"><strong aria-hidden="true">2.2.</strong> RFC-0111: Base node architecture</a></li><li class="chapter-item expanded "><a href="RFC-0120_Consensus.html"><strong aria-hidden="true">2.3.</strong> RFC-0120: Consensus rules</a></li><li class="chapter-item expanded "><a href="RFC-0131_Mining.html"><strong aria-hidden="true">2.4.</strong> RFC-0131: Mining</a></li><li class="chapter-item expanded "><a href="RFC-0132_Merge_Mining_Monero.html"><strong aria-hidden="true">2.5.</strong> RFC-0132: Merge Mining Monero</a></li><li class="chapter-item expanded "><a href="RFC-0140_Syncing_and_seeding.html"><strong aria-hidden="true">2.6.</strong> RFC-0140: Synchronizing the Blockchain: Archival and Pruned modes</a></li><li class="chapter-item expanded "><a href="RFC-0150_Wallets.html"><strong aria-hidden="true">2.7.</strong> RFC-0150: Wallets</a></li><li class="chapter-item expanded "><a href="RFC-0154_DeepLinksConvencion.html"><strong aria-hidden="true">2.8.</strong> RFC-0154: Deep Links</a></li><li class="chapter-item expanded "><a href="RFC-0155_TariAddress.html"><strong aria-hidden="true">2.9.</strong> RFC-0155: TariAddress</a></li><li class="chapter-item expanded "><a href="RFC-0160_BlockSerialization.html"><strong aria-hidden="true">2.10.</strong> RFC-0160: Block Binary Serialization</a></li><li class="chapter-item expanded "><a href="RFC-0170_NetworkCommunicationProtocol.html"><strong aria-hidden="true">2.11.</strong> RFC-0170: Network Communication Protocol</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="RFC-0171_MessageSerialisation.html"><strong aria-hidden="true">2.11.1.</strong> RFC-0171: Message Serialisation</a></li><li class="chapter-item expanded "><a href="RFC-0172_PeerToPeerMessagingProtocol.html"><strong aria-hidden="true">2.11.2.</strong> RFC-0172: Peer to Peer Messaging Protocol</a></li><li class="chapter-item expanded "><a href="RFC-0173_Versioning.html"><strong aria-hidden="true">2.11.3.</strong> RFC-0173: Versioning</a></li><li class="chapter-item expanded "><a href="RFC-0174_Chat_Metadata.html"><strong aria-hidden="true">2.11.4.</strong> RFC-0174: Chat Metadata</a></li></ol></li><li class="chapter-item expanded "><a href="RFC-0181_BulletproofsPlus.html"><strong aria-hidden="true">2.12.</strong> RFC-0181: Bulletproofs+ range proving</a></li><li class="chapter-item expanded "><a href="RFC-0182_CommitmentSignatures.html"><strong aria-hidden="true">2.13.</strong> RFC-0182: Commitment signatures</a></li><li class="chapter-item expanded "><a href="RFC-0190_Mempool.html"><strong aria-hidden="true">2.14.</strong> RFC-0190: Mempool</a></li><li class="chapter-item expanded "><a href="BaseLayerExtensions.html"><strong aria-hidden="true">2.15.</strong> Tari-specific extensions to Mimblewimble</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="RFC-0201_TariScript.html"><strong aria-hidden="true">2.15.1.</strong> RFC-0201: TariScript</a></li><li class="chapter-item expanded "><a href="RFC-0202_TariScriptOpcodes.html"><strong aria-hidden="true">2.15.2.</strong> RFC-0202: TariScript Opcodes</a></li><li class="chapter-item expanded "><a href="RFC-0204_TariScriptExamples.html"><strong aria-hidden="true">2.15.3.</strong> RFC-0204: TariScript Examples</a></li><li class="chapter-item expanded "><a href="RFC-0203_StealthAddresses.html"><strong aria-hidden="true">2.15.4.</strong> RFC-0203: Stealth Addresses</a></li><li class="chapter-item expanded "><a href="RFC-0205_HardwareTransactions.html"><strong aria-hidden="true">2.15.5.</strong> RFC-0205: Hardware Transactions</a></li><li class="chapter-item expanded "><a href="RFC-0250_Covenants.html"><strong aria-hidden="true">2.15.6.</strong> RFC-0250: Covenants</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="RFC-0303_DanOverview.html"><strong aria-hidden="true">3.</strong> RFC-0303: The Tari Digital Assets Network</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="RFC-0313_VNRegistration.html"><strong aria-hidden="true">3.1.</strong> RFC-0313: Validator Node Registration</a></li><li class="chapter-item expanded "><a href="RFC-0320_TurbineModel.html"><strong aria-hidden="true">3.2.</strong> RFC-0320: The turbine model</a></li><li class="chapter-item expanded "><a href="RFC-0350_TariVM.html"><strong aria-hidden="true">3.3.</strong> RFC-0350: The Tari Virtual Machine</a></li></ol></li><li class="chapter-item expanded "><a href="RFC-0305_Consensus.html"><strong aria-hidden="true">4.</strong> RFC-0305: The Tari Network Consensus Layer</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="RFC-0314_VNCSelection.html"><strong aria-hidden="true">4.1.</strong> RFC-0314: Validator node committee selection</a></li><li class="chapter-item expanded "><a href="RFC-0321_ProcessingForeignProposals.html"><strong aria-hidden="true">4.2.</strong> RFC-0321: Processing foreign proposals</a></li><li class="chapter-item expanded "><a href="RFC-0325_DanTimeManagement.html"><strong aria-hidden="true">4.3.</strong> RFC-0325: Epochs and time management</a></li><li class="chapter-item expanded "><a href="RFC-0330_Cerberus.html" class="active"><strong aria-hidden="true">4.4.</strong> RFC-0330: The Cerberus-Hotstuff consensus algorithm</a></li><li class="chapter-item expanded "><a href="RFC-0331_Indexers.html"><strong aria-hidden="true">4.5.</strong> RFC-0331: Indexers</a></li></ol></li><li class="chapter-item expanded "><a href="proposals.html"><strong aria-hidden="true">5.</strong> Proposals and Applications</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="RFC-0123_One_sided_replay_attacks.html"><strong aria-hidden="true">5.1.</strong> RFC-0123: Mitigating One-sided payment replay attacks</a></li><li class="chapter-item expanded "><a href="RFC-0141_Sparse_Merkle_Trees.html"><strong aria-hidden="true">5.2.</strong> RFC-0141: Sparse Merkle Tees</a></li><li class="chapter-item expanded "><a href="RFC-0153_StagedWalletSecurity.html"><strong aria-hidden="true">5.3.</strong> RFC-0153: Staged Wallet Security</a></li><li class="chapter-item expanded "><a href="RFC-0154_DeepLinksConvencion.html"><strong aria-hidden="true">5.4.</strong> RFC-0154: Deep links structure convention</a></li><li class="chapter-item expanded "><a href="RFC-0230_HTLC.html"><strong aria-hidden="true">5.5.</strong> RFC-0230: Hash time locked contracts</a></li><li class="chapter-item expanded "><a href="RFC-0240_AtomicSwap.html"><strong aria-hidden="true">5.6.</strong> RFC-0240: Atomic swap</a></li><li class="chapter-item expanded "><a href="RFC-0241_AtomicSwapXMR.html"><strong aria-hidden="true">5.7.</strong> RFC-0241: XMR Atomic swap</a></li><li class="chapter-item expanded "><a href="RFC-0310_SubmarineSwaps.html"><strong aria-hidden="true">5.8.</strong> RFC-0310: Submarine swaps</a></li><li class="chapter-item expanded "><a href="RFC-0388_BearerTokens.html"><strong aria-hidden="true">5.9.</strong> RFC-0388: Bearer tokens</a></li><li class="chapter-item expanded "><a href="RFC-8001_MultiPartyTransactions.html"><strong aria-hidden="true">5.10.</strong> RFC-8001: Multi-party transactions</a></li><li class="chapter-item expanded "><a href="RFC-8002_TransactionProtocol.html"><strong aria-hidden="true">5.11.</strong> RFC-8002: Transaction protocol</a></li><li class="chapter-item expanded "><a href="RFC-8003_TariUseCases.html"><strong aria-hidden="true">5.12.</strong> RFC-8003: Tari Use Cases</a></li><li class="chapter-item expanded "><a href="RFC-0385_StableCoins.html"><strong aria-hidden="true">5.13.</strong> RFC-0385: Privacy-enabled Stablecoin contract design</a></li><li class="chapter-item expanded "><a href="RFC-0323_TariThrottle.html"><strong aria-hidden="true">5.14.</strong> RFC-0323: Tari throttle exploratory analysis</a></li></ol></li><li class="chapter-item expanded "><a href="deprecated.html"><strong aria-hidden="true">6.</strong> Deprecated RFCs</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="RFCD-0010_CodeStructure.html"><strong aria-hidden="true">6.1.</strong> RFC-0010: Tari code structure and organization</a></li><li class="chapter-item expanded "><a href="RFCD-0121_ConsensusEncoding.html"><strong aria-hidden="true">6.2.</strong> RFC-0121: Consensus encoding</a></li><li class="chapter-item expanded "><a href="RFCD-0130_Mining.html"><strong aria-hidden="true">6.3.</strong> RFC-0130: Mining</a></li><li class="chapter-item expanded "><a href="RFCD-0152_EmojiId.html"><strong aria-hidden="true">6.4.</strong> RFCD-0152: Emoji ID</a></li><li class="chapter-item expanded "><a href="RFCD-0180_BulletproofRewinding.html"><strong aria-hidden="true">6.5.</strong> RFC-0180: Bulletproof range proof rewinding</a></li><li class="chapter-item expanded "><a href="RFCD-0300_DAN.html"><strong aria-hidden="true">6.6.</strong> RFC-0300: The Digital Assets Network</a></li><li class="chapter-item expanded "><a href="RFCD-0301_NamespaceRegistration.html"><strong aria-hidden="true">6.7.</strong> RFC-0301: Namespace Registration</a></li><li class="chapter-item expanded "><a href="RFCD-0302_ValidatorNodes.html"><strong aria-hidden="true">6.8.</strong> RFC-0302: Validator Nodes</a></li><li class="chapter-item expanded "><a href="RFCD-0304_VNCommittees.html"><strong aria-hidden="true">6.9.</strong> RFC-0304: Validator Node committee selection</a></li><li class="chapter-item expanded "><a href="RFCD-0306_DANTemplateRegistration.html"><strong aria-hidden="true">6.10.</strong> RFC-0306: DAN Template Registration</a></li><li class="chapter-item expanded "><a href="RFCD-0311_AssetTemplates.html"><strong aria-hidden="true">6.11.</strong> RFC-0311: Digital Asset templates</a></li><li class="chapter-item expanded "><a href="RFCD-0312_DANHighLevelSpecification.html"><strong aria-hidden="true">6.12.</strong> RFC-0312: High level Digital Asset Network Specification</a></li><li class="chapter-item expanded "><a href="RFCD-0322_VNRegistration.html"><strong aria-hidden="true">6.13.</strong> RFC-0322: Validator Node Registration</a></li><li class="chapter-item expanded "><a href="RFCD-0340_VNConsensusOverview.html"><strong aria-hidden="true">6.14.</strong> RFC-0340: Validator Node Consensus</a></li><li class="chapter-item expanded "><a href="RFCD-0341_AssetRegistration.html"><strong aria-hidden="true">6.15.</strong> RFC-0341: Asset registration</a></li><li class="chapter-item expanded "><a href="RFCD-0345_AssetLifeCycle.html"><strong aria-hidden="true">6.16.</strong> RFC-0345: Asset Life cycle</a></li><li class="chapter-item expanded "><a href="RFCD-0360_NFTInvoices.html"><strong aria-hidden="true">6.17.</strong> RFC-0360: NFT sale using MimbleWimble Invoice</a></li><li class="chapter-item expanded "><a href="RFCD-0500_PaymentChannels.html"><strong aria-hidden="true">6.18.</strong> RFC-0500: Tari payment channels</a></li></ol></li><li class="chapter-item expanded "><a href="RFC_template.html"><strong aria-hidden="true">7.</strong> RFC template</a></li><li class="chapter-item expanded "><a href="Glossary.html"><strong aria-hidden="true">8.</strong> Glossary</a></li></ol>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar" class="menu-bar">
                    <div id="menu-bar-sticky-container">
                        <div class="left-buttons">
                            <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                                <i class="fa fa-bars"></i>
                            </button>
                            <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                                <i class="fa fa-search"></i>
                            </button>
                        </div>

                        <h1 class="menu-title"><img src="theme/images/tari-horizontal-logo.png"/> </h1>

                        <div class="right-buttons">
                            <a href="print.html" title="Print this book" aria-label="Print this book">
                                <i id="print-button" class="fa fa-print"></i>
                            </a>
                        </div>
                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="rfc-0330cerberus"><a class="header" href="#rfc-0330cerberus">RFC-0330/Cerberus</a></h1>
<h2 id="the-tari-cerberus-hotsuff-consensus-algorithm"><a class="header" href="#the-tari-cerberus-hotsuff-consensus-algorithm">The Tari Cerberus-Hotsuff Consensus Algorithm</a></h2>
<p><img src="theme/images/status-draft.svg" alt="status: draft" /></p>
<p><strong>Maintainer(s)</strong>: <a href="https://github.com/CjS77">Cayle Sharrock</a>,<a href="https://github.com/stringhandler">stringhandler</a></p>
<h1 id="licence"><a class="header" href="#licence">Licence</a></h1>
<p><a href="https://opensource.org/licenses/BSD-3-Clause">The 3-Clause BSD Licence</a>.</p>
<p>Copyright 2022 The Tari Development Community</p>
<p>Redistribution and use in source and binary forms, with or without modification, are permitted provided that the
following conditions are met:</p>
<ol>
<li>Redistributions of this document must retain the above copyright notice, this list of conditions and the following
disclaimer.</li>
<li>Redistributions in binary form must reproduce the above copyright notice, this list of conditions and the following
disclaimer in the documentation and/or other materials provided with the distribution.</li>
<li>Neither the name of the copyright holder nor the names of its contributors may be used to endorse or promote products
derived from this software without specific prior written permission.</li>
</ol>
<p>THIS DOCUMENT IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS &quot;AS IS&quot;, AND ANY EXPRESS OR IMPLIED WARRANTIES,
INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
SPECIAL, EXEMPLARY OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR
SERVICES; LOSS OF USE, DATA OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY,
WHETHER IN CONTRACT, STRICT LIABILITY OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF
THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</p>
<h2 id="language"><a class="header" href="#language">Language</a></h2>
<p>The keywords &quot;MUST&quot;, &quot;MUST NOT&quot;, &quot;REQUIRED&quot;, &quot;SHALL&quot;, &quot;SHALL NOT&quot;, &quot;SHOULD&quot;, &quot;SHOULD NOT&quot;, &quot;RECOMMENDED&quot;,
&quot;NOT RECOMMENDED&quot;, &quot;MAY&quot; and &quot;OPTIONAL&quot; in this document are to be interpreted as described in
<a href="https://tools.ietf.org/html/bcp14">BCP 14</a> (covering RFC2119 and RFC8174) when, and only when, they appear in all
capitals, as
shown here.</p>
<h2 id="disclaimer"><a class="header" href="#disclaimer">Disclaimer</a></h2>
<p>This document and its content are intended for information purposes only and may be subject to change or update
without notice.</p>
<p>This document may include preliminary concepts that may or may not be in the process of being developed by the Tari
community. The release of this document is intended solely for review and discussion by the community of the
technological merits of the potential system outlined herein.</p>
<h2 id="goals"><a class="header" href="#goals">Goals</a></h2>
<p>This Request for Comment (RFC) describe the consensus mechanism known as Cerberus as it is implemented in Tari.
Tari implements the Cerberus variant known as Optimistic Cerberus, for the most part, with Hotstuff BFT replacing
pBFT as described in the Cerberus paper.</p>
<p>This RFC serves to document any deviations from the academic paper as well as finer-grained details of the
implementation.</p>
<h2 id="related-requests-for-comment"><a class="header" href="#related-requests-for-comment">Related Requests for Comment</a></h2>
<ul>
<li><a href="./RFC-0303_DanOverview.html">RFC-303: Digital Assets Network</a></li>
</ul>
<h2 id="introduction"><a class="header" href="#introduction">Introduction</a></h2>
<p>The Tari DAN is based on a sharded BFT consensus mechanism called <a href="https://arxiv.org/abs/2008.04450">Cerberus</a>.</p>
<p>One particular note is that Tari has chosen Hotstuff as the base BFT consensus algorithm over pBFT mentioned in the
paper.</p>
<p>The core idea of Cerberus is that instead of dividing work up between validator nodes according to the contracts
they are managing (as per Tari DANv1, Polkadot, Avalanche, etc.), Cerberus distributes nodes evenly over a set of
state slots, called substates. Any time an instruction modifies the state of a contract, it will affect one or more
substates, and only those nodes that are responsible for covering those addresses will reach consensus on the correct
state changes.</p>
<p>This means that nodes have to be prepared to execute instructions on any contract in the network. This
does create a data synchronisation burden, but the added benefit of a highly scalable, decentralised DAN significantly
outweighs this trade-off.</p>
<h2 id="shards-substates-and-state-addresses"><a class="header" href="#shards-substates-and-state-addresses">Shards, substates and state addresses</a></h2>
<p>The central idea of Cerberus is that all possible state objects are assigned a unique address, deterministically.
Know the provenance of the state, know the address <sup class="footnote-reference"><a href="#1">1</a></sup>. The state space is incredibly large, with 2^256 possible 
substate addresses;
which is way more than the number of atoms in our galaxy.
The chance of any two pieces of state ever trying to occupy the same substate is vanishingly small.</p>
<p>The state space is also evenly divided into contiguous sections, called shards. Each shard covers a set of
non-overlapping substate addresses and the full set of shards covers the entire state space.</p>
<p>Each validator node registered on the base layer is randomly assigned a shard to cover. The number of shards
depends on the total number of validator nodes in the network.</p>
<p>Collectively, all the nodes covering the same shard are known as a <em>validator (node) committee</em> (VNC).</p>
<p>Broadly speaking, the shard-assignment algorithm will try to arrange things in a way that every shard has the same
number of validator nodes covering it.</p>
<p>The number of nodes in a VNC is set system-wide. The final number has not been determined yet, but it will be a
value, 3n+1, where n is an integer between 8 and 33, giving a committee size of between 25 and 100 nodes.</p>
<p>As nodes continue to join the network, the target committee size stays fixed, whereas the shard size will shrink.
This is what will allow the Tari network to scale to achieve
<a href="https://www.tari.com/updates/2023-09-11-update-117">thousands of transactions per second</a>.</p>
<p>Every substate slot can only be used once. The substate lifecycle is</p>
<ul>
<li><code>Empty</code>. No state has ever been stored in this slot.</li>
<li><code>Up</code>. A transaction output has resulted in some object being stored in this substate slot.</li>
<li><code>Down</code>. The state in this slot has changed. We mark the substate as 'down' to indicate that the state is no longer
valid. Once a substate is down, it can never be used again <sup class="footnote-reference"><a href="#2">2</a></sup>.</li>
</ul>
<div class="footnote-definition" id="1"><sup class="footnote-definition-label">1</sup>
<p>This is a simplification to convey the general idea. The address derivation procedure is explained in full below.</p>
</div>
<div class="footnote-definition" id="2"><sup class="footnote-definition-label">2</sup>
<p>It's possible that substates could be reset, decades in the future, if substate address collisions
become a risk. For now, we treat all down substates as permanently unusable.</p>
</div>
<h2 id="braided-consensus"><a class="header" href="#braided-consensus">Braided consensus</a></h2>
<p>A question that naturally arises whenever sharded distributed networks are discussed is, what happens when
cross-shard communication happens. With Cerberus, the procedure is that affected shards come together to form a
temporary Hotstuff consensus group, and reach agreement on the correct outcome of the instruction.</p>
<p>A correct outcome is one of:</p>
<ul>
<li><code>Abort</code>: The instruction was invalid, and any state changes are rolled back such that the instruction never happened.</li>
<li><code>Commit</code>: All input substates for the instruction will be set to <code>Down</code>, and at least one new substate will be
marked to <code>Up</code> (from <code>Empty</code>).</li>
</ul>
<p>Achieving this outcome entails a fairly complicated dance between the participating nodes<sup class="footnote-reference"><a href="#3">3</a></sup>:</p>
<ul>
<li>When nodes receive an instruction that affects contract state, the nodes determine the <em>input substates</em> that will
be consumed in the instruction. This substates MUST currently <em>all</em> be in an <code>Up</code> state. If any input state is
<code>Empty</code>, or <code>Down</code>, the nodes can immediately vote <code>Abort</code> on the instruction.</li>
<li>Assuming all input states are valid, nodes will then <em>pledge</em> these substates, effectively marking them as pending
<code>Down</code>.</li>
<li>Then we have cross-shard exchange. Every leader for the round will forward the instruction and the pledged states
to all other nodes in the wider consensus group.</li>
<li>Nodes wait until they have received the transaction and pledges from all the other committee leaders. Otherwise
they time-out, and ???.</li>
<li>Once this is complete, and all pledges have been received, nodes decide within their local committee whether to
<code>Commit</code> or <code>Abort</code>. This procedure proceeds via Hotstuff consensus rules and takes several rounds of
communication between the local leader and the committee members.</li>
</ul>
<div class="footnote-definition" id="3"><sup class="footnote-definition-label">3</sup>
<p>For a more formal treatment, refer to Pessimistic-Cerberus in the
<a href="https://arxiv.org/abs/2008.04450">Cerberus paper</a>.</p>
</div>
<h2 id="cerberus-consensus---a-diagram"><a class="header" href="#cerberus-consensus---a-diagram">Cerberus consensus - a diagram</a></h2>
<p>Transaction processing for Pessimistic Cerberus follows the following broad algorithm:</p>
<ol>
<li>A client broadcasts a transaction to multiple validator nodes, ensuring that at least one node from every shard
that covers the inputs for the transaction receives the transaction. In practice, this can be achieved by
communicating with a single node, and the node shoulders the responsibility of broadcasting the transaction to
the rest of the network, including to every node in the node's local VNC.</li>
<li>When a transaction is received by a validator node, it checks to see if at least one input for the transaction is
in the node's shard space. If not, it may ignore the transaction. Otherwise, it forwards the message to the
current round leader.</li>
<li>Soon, every round leader for the shards that contain affected inputs will have received the transaction.</li>
<li>The affected shards then begin the <em>local consensus</em> phase. This consists of a full Hotstuff consensus chain with
the leader proposing a new block containing the transaction, and the committee members voting on the block.</li>
<li>At the same time, all local inputs (the subset of transaction inputs covered by the local shard) are marked as
<code>Pledged</code>. If any input is already marked as <code>Pledged</code>, the transaction immediately resolves as <code>Abort</code>. This step
prevents double-spending of inputs across concurrent transactions in separate shards. Note that if a double-spend
is attempted by submitting the two transactions to different shards, then <em>both</em> transactions will be aborted, since
Cerberus does not have a way to determine which transaction was 'first'.</li>
<li>If <em>every</em> input is in a single shard, then the local consensus is sufficient to finalise the outcome of the
transaction (proceeding to execution phase as described below), and the result can be broadcast to the client.</li>
<li>Otherwise, the leader of the round broadcasts the transaction, some metadata, and the local input state to the
other shards leaders involved in the transaction. Notice that up until this point, <em>execution</em> of the transaction is
impossible in a multi-shard transaction because no node has all the input state it needs to run the transaction
instruction. The local consensus phase is solely to determine the validity of the transaction from an input and
double-spend perspective.</li>
<li>When every shard leader has received a message from every other shard leader participating the transaction, and
none of the messages received was <code>Abort</code>, then the shards can begin the <em>global consensus</em> phase.</li>
<li>Round leaders transmit the received messages to the rest of their VNC.</li>
<li>Each VN checks that the state received from each foreign shard corresponds to the inputs in the transaction. If
not, the VN can immediately vote <code>Abort</code>.</li>
<li>At this point, the shard leaders have all the state they need to execute the transaction. Execution is handed off
to the TariVM which returns a new set of state objects as output. It is important to note that if a transaction
<em>execution</em> returns an error (because someone tried to spend more than they have, for example), then this _does
not lead to an <code>Abort</code> decision!`</li>
<li>Each shard executes the transaction independently, and another Hotstuff consensus chain is produced to achieve
consensus on the resulting output set. If the transaction is <code>Abort</code>, then all pledged inputs are rolled back.
Otherwise, the decision is <code>Commit</code>, and the pledged inputs are marked as <code>Down</code>. Any output objects that belong
in the current shard can be marked as <code>Up</code>, and the transaction result is broadcast to the client as well as
other shards that need to mark new substates as <code>Up</code> as a result of the transaction output.</li>
</ol>
<p>A mermaid flow diagram of the above process is shown below:</p>
<pre class="mermaid">
flowchart TD
    A[Client] --&gt; B([Broadcast transaction])
    B --&gt; C{Any tx inputs in my shard?}
    C --&gt; |Yes| D[Forward to leader]
    C --&gt; |No| E[Ignore transaction]
    D -.-&gt; L
    
    L[Leader] ==&gt; BL([ Broadcast message to VNC ])
    BL -.-&gt; |PREPARE| LN[VNC nodes]
    subgraph Local_Consensus
        LN --&gt; G{Any inputs already pledged?}    
        G --&gt; |Yes. 
        Vote PREPARED_ABORT | LC
        
        G --&gt; |No| I[Pledge inputs]
        I --&gt; |Vote PREPARED_COMMIT| LC[[Consensus on pledges]]
        LC --&gt; LCD{Consensus on PREPARED?}
        LCD --&gt; |No| LocalStall[Local liveness break!]
    end
        
    
    LCD --&gt; |Yes| Pledge[Pledge inputs]
    Pledge --&gt; SS{ Single shard tx? }
    SS --&gt; |Yes| EX1[[Execute transaction]]
    EX1 --&gt; SSC[[Consensus on result]]
    SSC --&gt; GCD
    
    ssCommit --&gt; |No| Abort[Abort!] 
    ssCommit --&gt; |Yes| createSubstates[[Substate creation]]
    
    SS -.-&gt; |No| BLC([ Send LOCAL_PREPARED_*
     &amp; local state to other Leaders ])
    BLC -.-&gt; Leaders
    Leaders -.-&gt; |Forward to VNC| Fwd[Validator node]
    
    subgraph Global_consensus
        Fwd --&gt; wait{Are ANY messages 
        LOCAL_PREPARED_ABORT or
        timed out? }
        wait --&gt; |Yes
        Vote SOMEPREPARED_ABORT| globalConsensus
        wait --&gt; |No| EX[[Execute transaction]]
        
        EX --&gt; |Vote ACCEPT_*| globalConsensus[[Intershard Consensus on result]]
    end
    globalConsensus --&gt; GCD{Consensus on ACCEPT_*?}
    GCD --&gt; |No.| Stall[Abandon block!]
    GCD--&gt; |Yes| ssCommit{Decision == ACCEPT_COMMIT?}
</pre>
<p>The process above describes PCerberus in general, with some modifications from <a href="https://arxiv.org/pdf/1708.03778.pdf" title="Chainspace whitepaper">Chainspace</a>. There are a few details
that need some additional explanation. In particular, this includes substate address derivation and state
synchronisation.</p>
<h2 id="substate-address-derivation"><a class="header" href="#substate-address-derivation">Substate address derivation</a></h2>
<p>A substate contains two pieces of information:</p>
<ul>
<li>The value of the substate object,</li>
<li>The version number of the substate object.</li>
</ul>
<p>The <em>substate address</em> is the universal location of the substate in the 256-bit state space. Most substate addresses
are derived from a hash of their id, the provenance of which depends on the substate value type, and their version.</p>
<p>The substate value depends on the type of data the value represents. It is exactly one of the following:</p>
<ul>
<li>Component - A component is an instantiation of a <a href="RFC-0303_DanOverview.html#templates">contract template</a>.</li>
<li>Resource - A resource represents a token. Tokens can be fungible, non-fungible, or confidential. The <code>Resource</code>
substate does not store the tokens themselves, but serves as the global identifier for the resource. The tokens
themselves are kept in <code>Vaults</code>, or <code>NonFungible</code> substates.</li>
<li>Vault - Resources are stored in Vaults. Vaults provide generalised functionality for depositing and withdrawing
their resources from the vaults into Buckets.</li>
<li>NonFungible - A substate representing a singular non-fungible item. Non-fungible items are always associated with
their associated non-fungible <code>Resource</code>.</li>
<li>NonFungibleIndex - A substate that holds a reference to another substate.</li>
<li>UnclaimedConfidentialOutput - A substate representing funds that were burnt on the Minotari layer and are yet to
be claimed in the Tari network.</li>
<li>TransactionReceipt - A substate recording the result of a transaction.</li>
<li>FeeClaim - To prevent a proliferation of dust-like value transfers for every transaction due to fees, a fee claim is
generated instead that allows VNs to aggregate fees and claim them in a single batched transaction at a later time.
Fee claims remain in the up state forever to prevent double claims.</li>
</ul>
<p>Substate ids are domain-separated hashes of their identifying data, which depends on substate type as follows:</p>
<ul>
<li>Component - Component addresses are derived from the hash of the component's contract template id and a component
id. The component id is typically a hash of the origin transaction's hash and a counter.</li>
<li>Resource - Generally a unique, random 256-bit integer, derived from the hash of the transaction hash and a counter.
Some ids for special resources are hard-coded.</li>
<li>Vault - Vault ids are a unique, random 256-bit integer, derived from the hash of the transaction hash and a counter.</li>
<li>NonFungible - The id of a non-fungible item is derived from the item's resource address, and its id. The id
depends on the specifics of the NFT, and could be an integer, a string, a hash, or a uuid.</li>
<li>NonFungibleIndex - Non-fungible index ids are derived from the resource they are pointing to and an index offset.</li>
<li>UnclaimedConfidentialOutput - The UCO id is derived from the burn commitment on the Minotari layer.</li>
<li>TransactionReceipt - The id of a transaction receipt is the hash of the associated transaction.</li>
<li>FeeClaim - The id of a fee claim is derived from the epoch number and the validator's public key.</li>
</ul>
<h2 id="state-synchronisation"><a class="header" href="#state-synchronisation">State synchronisation</a></h2>
<h1 id="change-log"><a class="header" href="#change-log">Change Log</a></h1>
<div class="table-wrapper"><table><thead><tr><th style="text-align: left">Date</th><th style="text-align: left">Change</th><th style="text-align: left">Author</th></tr></thead><tbody>
<tr><td style="text-align: left">17 Dec 2023</td><td style="text-align: left">Second draft</td><td style="text-align: left">CjS77</td></tr>
<tr><td style="text-align: left">30 Oct 2023</td><td style="text-align: left">First draft</td><td style="text-align: left">CjS77</td></tr>
</tbody></table>
</div>
                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="RFC-0325_DanTimeManagement.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next" href="RFC-0331_Indexers.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a href="RFC-0325_DanTimeManagement.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a href="RFC-0331_Indexers.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>

        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <script src=" https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js "></script>
        <script>mermaid.initialize({startOnLoad:true});</script>

        <!-- Custom JS scripts -->


    </body>
</html>
